# 匹配学习机制使用说明

## 📋 概述

系统已实现自我学习机制，可以根据历史匹配数据自动改进匹配精度。学习机制会自动收集匹配数据，分析匹配模式，并应用到后续的匹配中。

---

## 🚀 快速开始

### 1. 自动学习（推荐）

系统会自动进行学习，无需手动操作：

- **数据收集**：每次匹配完成后自动收集匹配数据
- **定时分析**：每天凌晨2点自动分析学习数据，更新权重和规则
- **自动应用**：学习结果会自动应用到后续匹配中

### 2. 手动触发学习

如果需要立即触发学习分析，可以使用以下API：

#### 收集历史数据
```bash
POST /api/quota/learning/collect
```
收集所有历史匹配数据到学习记录表。

#### 执行学习分析
```bash
POST /api/quota/learning/analyze
```
立即执行学习分析，更新关键词权重和同义词规则。

---

## 📊 学习数据来源

系统会从以下数据中学习：

1. **自动匹配结果**（matchStatus = 1）
   - 权重：0.5
   - 说明：系统自动匹配的结果

2. **手动修改结果**（matchStatus = 2）
   - 权重：1.0（高权重）
   - 说明：用户手动修改的匹配，视为"正确答案"

3. **多定额匹配**（matchStatus = 3）
   - 权重：1.0（高权重）
   - 说明：用户手动组合的定额，视为"正确答案"

---

## 🔄 学习流程

### 阶段1：数据收集（自动）

每次匹配完成后，系统会：
1. 提取项目清单和定额的关键词
2. 计算共同关键词
3. 保存匹配记录到 `matching_learning_record` 表

### 阶段2：数据分析（定时任务）

每天凌晨2点，系统会：
1. 分析所有学习记录
2. 统计关键词匹配成功率
3. 更新关键词权重（`keyword_weight` 表）
4. 发现同义词关系（`matching_rule` 表）

### 阶段3：应用学习结果（自动）

在匹配时，系统会：
1. 加载学习到的关键词权重
2. 使用学习到的同义词扩展匹配
3. 应用动态权重计算匹配得分

---

## 📈 学习效果

### 短期（1-2周）
- 收集100-500条匹配记录
- 识别常见关键词权重
- 发现10-20组同义词

### 中期（1-2月）
- 收集1000-5000条匹配记录
- 建立关键词权重库
- 发现50-100组同义词
- **匹配准确率提升10-20%**

### 长期（3-6月）
- 建立完整的匹配规则库
- **匹配准确率提升30-50%**
- 大幅减少手动修改工作量

---

## 🛠️ 数据库表说明

### matching_learning_record（学习记录表）
存储每次匹配的详细信息，包括：
- 项目清单和定额的名称、特征值
- 提取的关键词
- 匹配得分和类型
- 学习权重

### keyword_weight（关键词权重表）
存储学习到的关键词权重：
- `keyword`：关键词
- `weight`：权重值（0.5-2.0）
- `match_count`：匹配成功次数
- `total_count`：出现总次数
- `success_rate`：成功率

### matching_rule（匹配规则表）
存储学习到的匹配规则：
- `rule_type`：规则类型（synonym, pattern, weight）
- `source_text`：源文本
- `target_text`：目标文本
- `confidence`：置信度（0-1）
- `usage_count`：使用次数

---

## ⚙️ 配置说明

学习机制默认启用，无需额外配置。如需调整，可以修改以下参数：

```java
// MatchingLearningService.java
private static final double AUTO_MATCH_WEIGHT = 0.5;  // 自动匹配权重
private static final double MANUAL_MATCH_WEIGHT = 1.0; // 手动修改权重
```

定时任务配置：
```java
// LearningScheduler.java
@Scheduled(cron = "0 0 2 * * ?")  // 每天凌晨2点执行
```

---

## 📝 使用建议

### 1. 初始阶段（第1-2周）
- 正常使用系统进行匹配
- 对于匹配错误的结果，手动修改（这样系统会学习到正确答案）
- 系统会自动收集数据，但暂不进行学习（数据量不足）

### 2. 学习阶段（第2-4周）
- 数据量达到100条以上后，系统开始学习
- 可以手动触发学习分析：`POST /api/quota/learning/analyze`
- 观察匹配准确率是否提升

### 3. 优化阶段（1-2月后）
- 系统已建立基础规则库
- 匹配准确率明显提升
- 继续使用系统，系统会持续学习改进

### 4. 维护阶段
- 定期检查学习数据质量
- 可以手动触发学习分析优化规则
- 系统会持续自动学习和改进

---

## 🔍 查看学习效果

### 1. 查看学习记录数量
```sql
SELECT COUNT(*) FROM matching_learning_record;
```

### 2. 查看关键词权重
```sql
SELECT keyword, weight, success_rate, match_count, total_count 
FROM keyword_weight 
ORDER BY weight DESC 
LIMIT 20;
```

### 3. 查看同义词规则
```sql
SELECT source_text, target_text, confidence, usage_count 
FROM matching_rule 
WHERE rule_type = 'synonym' 
ORDER BY confidence DESC;
```

---

## ⚠️ 注意事项

1. **数据质量**：手动修改的数据（matchStatus=2）权重更高，是学习的主要来源
2. **学习时间**：需要积累一定数据量（建议100条以上）才开始有效学习
3. **性能影响**：学习机制是异步的，不会影响正常匹配性能
4. **规则验证**：新发现的规则需要验证，避免错误规则影响匹配

---

## 🐛 故障排查

### 问题1：学习数据没有收集
- 检查是否有匹配记录（matchStatus > 0）
- 检查数据库连接是否正常
- 查看应用日志是否有错误

### 问题2：学习分析没有执行
- 检查定时任务是否启用（`@EnableScheduling`）
- 可以手动触发：`POST /api/quota/learning/analyze`
- 查看应用日志确认执行情况

### 问题3：匹配准确率没有提升
- 确认数据量是否足够（建议100条以上）
- 检查手动修改的数据是否足够（这些是"正确答案"）
- 查看关键词权重是否正常更新

---

## 📞 技术支持

如有问题，请查看：
- 设计方案文档：`MATCHING-LEARNING-DESIGN.md`
- 应用日志：检查学习相关的日志输出
- 数据库表：检查学习数据是否正确保存

